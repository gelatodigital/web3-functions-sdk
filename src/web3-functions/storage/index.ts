import {
  Web3Function,
  Web3FunctionContext,
} from "@gelatonetwork/web3-functions-sdk";

Web3Function.onRun(async (context: Web3FunctionContext) => {
  const { storage, multiChainProvider } = context;

  const provider = multiChainProvider.default();

  // Use storage to manage your execution state
  const lastBlockStr = (await storage.get("lastBlockNumber")) ?? "0";

  // Stored values are always in string
  const lastBlock = parseInt(lastBlockStr);
  console.log(`Last block: ${lastBlock}`);

  const newBlock = await provider.getBlockNumber();
  console.log(`New block: ${newBlock}`);
  if (newBlock > lastBlock) {
    // Cast value to string before storing it
    await storage.set("lastBlockNumber", newBlock.toString());
  }

  console.log(`Storage Keys: ${await storage.getKeys()}`);
  console.log(`Storage Size: ${await storage.getSize()}`);

  return {
    canExec: false,
    message: `Updated block number: ${newBlock.toString()}`,
  };
});
